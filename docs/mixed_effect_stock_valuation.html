<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Brent Morrison" />

<meta name="date" content="2022-02-22" />

<title>Mixed effect stock valuation</title>

<script src="site_libs/header-attrs-2.8/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/spacelab.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Reference library</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Multi-level models
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="./mixed_effect_stock_valuation.html">First</a>
    </li>
    <li>
      <a href="./numpyro_models.html">Second</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Data wrangling
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">1.Top n by group</a>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a href="./dw_rb1.html">R - base</a>
        </li>
        <li>
          <a href="./dw_rd2.html">R - dplyr</a>
        </li>
        <li>
          <a href="./dw_rd1.html">R - data.table</a>
        </li>
        <li>
          <a href="./dw_py1.html">Python - pandas</a>
        </li>
      </ul>
    </li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">2.Placeholder</a>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a href="./dw_rd2.html">R - placeholder</a>
        </li>
        <li>
          <a href="./dw_rd2.html">Python - placeholder</a>
        </li>
      </ul>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="./sample_shapes.html">Numpyro shapes</a>
    </li>
    <li>
      <a href="./numpyro_models.html">Numpyro model</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Mixed effect stock valuation</h1>
<h4 class="author">Brent Morrison</h4>
<h4 class="date">2022-02-22</h4>

</div>


<blockquote>
<p><em>“datasets are often highly structured, containing clusters of non-independent observational units that are hierarchical in nature, and Linear Mixed Models allow us to explicitly model the non-independence in such data”</em><br />
(Harrison et al., 2018)[1]</p>
</blockquote>
<blockquote>
<p><em>They allow modeling of data measured on different levels at the same time, for instance students nested within classes and schools, thus taking complex dependency structures into account</em><br />
(Bürkner, 2018)[2]</p>
</blockquote>
<blockquote>
<p><em>These models inherently regularize estimates towards a central value to an extent that depends on the heterogeneity of the underlying groups.</em><br />
(Green &amp; Thomas, 2019)[3]</p>
</blockquote>
<blockquote>
<p><em>The regularizing aspects of the ‘partial pooling’ inherent in the structure of these models (averaging parameter estimates between in-group and across-subject loadings) help to mitigate the impacts of multiple comparisons by pulling an estimate towards its central tendency to the extent warranted by the between-group variance</em><br />
(Green &amp; Thomas, 2019)[3]</p>
</blockquote>
<p><br></p>
<p>An investigation into stock valuation using regression models. We will use a couple of different techniques. Ordinary least squares, multi-levels models (estimated using both frequentist and bayesian approaches), and robust regression.</p>
<p>The valuation model is the <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=534442">P/B - ROE model</a>. This model relates the ratio of market capitalisation over book value to return on equity. We expect that the slope of the regression co-efficient is positive, indicating that holding book value constant, a higher ROE leads to higher valuation.</p>
<p>As alluded to in the quotes above, the focus will be on multi-level models. Why? Multi-level models purport to provide more robust results by virtue of partial pooling. Partial pooling results in regularisation of parameter estimates. Robust regression techniques also purport to provide robust results (it’s all in the name isn’t it). Why not see how they compare.</p>
<p>The Theil-Sen regression, which has been discussed <a href="https://brentmorrison.netlify.app/post/abalone-and-outliers/">here</a> is a robust technique and works to dampen the impact of outliers. It does so whereby the slope is derived taking the median of many individual slopes, that being fitted to each pair of data points.</p>
<p>Two approaches that have a similar aim. It will be interesting to review the difference in fit between models that pool data, and those that use robust techniques.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgres)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DescTools)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mblm)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(romerb)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(recipes)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;stock_data&quot;</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>fundamental_raw <span class="ot">&lt;-</span> stock_data</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(stock_data)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Set default theme</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>def_theme1 <span class="ot">&lt;-</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;grey55&quot;</span>, <span class="at">face =</span> <span class="st">&#39;italic&#39;</span>), </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;darkslategrey&quot;</span>),</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;darkslategrey&quot;</span>),</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>, <span class="at">color =</span> <span class="st">&quot;darkslategrey&quot;</span>),</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>, <span class="at">color =</span> <span class="st">&quot;darkslategrey&quot;</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>The data comprises around 750 individual companies. These companies are grouped into 11 sectors and 40 odd industries. The data is as of June 2021 and comes from the Securites and Exchange Commission via my <a href="https://github.com/Brent-Morrison/Stock_master">Stock_master</a> database.</p>
<p>Below are the variables of interest.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> fundamental_raw <span class="sc">%&gt;%</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date_stamp <span class="sc">==</span> <span class="fu">as.Date</span>(<span class="st">&#39;2021-06-30&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_mkt_cap =</span> <span class="fu">log</span>(mkt_cap),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_assets =</span> <span class="fu">log</span>(total_assets),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_equity_cln =</span> <span class="fu">log</span>(<span class="sc">-</span>total_equity_cln),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">roe =</span> <span class="sc">-</span>roe,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">roe_s =</span> <span class="fu">scale</span>(roe),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">leverage_s =</span> <span class="fu">scale</span>(leverage),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sector =</span> <span class="fu">as.factor</span>(sector),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">industry =</span> <span class="fu">as.factor</span>(industry)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date_stamp, symbol, log_mkt_cap, log_assets, log_equity_cln, roe, roe_s, leverage, leverage_s, vol_ari_60d, sector, industry, log_pb)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(log_pb, log_mkt_cap, roe, log_assets, log_equity_cln, leverage),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&#39;attribute&#39;</span>, </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&#39;value&#39;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(value)) <span class="sc">+</span> </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">45</span>) <span class="sc">+</span> </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(attribute), <span class="at">scales =</span> <span class="st">&#39;free&#39;</span>) <span class="sc">+</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  def_theme1</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
</div>
<div id="aggregate-analysis" class="section level2">
<h2>Aggregate analysis</h2>
<p>The plot below shows the relationship between the log price/book ratio and ROE for all stocks regardless of sector or industry membership. The blue line is the regression line fitted using OLS, the grey line that fitted using the Theil-Sen robust estimator, and magenta is a GAM smooth.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For Theil Sen line https://stackoverflow.com/questions/48349858/how-can-i-use-theil-sen-method-with-geom-smooth</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sen <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">weights =</span> <span class="cn">NULL</span>) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  mblm<span class="sc">::</span><span class="fu">mblm</span>(...)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe_s, <span class="at">y =</span> log_pb)) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&#39;gam&#39;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">s</span>(x), <span class="at">size =</span> <span class="fl">0.6</span>, <span class="at">colour =</span> <span class="st">&#39;magenta&#39;</span>) <span class="sc">+</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">&quot;#3366FF&quot;</span>) <span class="sc">+</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> sen, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">colour =</span> <span class="st">&#39;grey&#39;</span>) <span class="sc">+</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Log book / price ratio versus return on equity&#39;</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Return on equity&#39;</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Log price / book ratio&#39;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">10</span>), <span class="at">color =</span> <span class="st">&quot;grey40&quot;</span>, <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  def_theme1</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>The Theil-Sen regression seems to fit the data better (at least on a rough eyeballing of the plot), fitting the dense cluster of data points more closely. As expected, the slope of the line is positive, indicating all else equal a higher valuation given higher return on equity.</p>
<p>There is a hint of non-linearity in the relationship.</p>
</div>
<div id="sector-analysis-1" class="section level2">
<h2>Sector analysis 1</h2>
<p>Stocks with similar characteristics are grouped into sectors.</p>
<p>The plot below shows the same regression models estimated above (the GAM has been removed), except now applied individually to each sector.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model coefficients for OLS and Thiel Sen regression</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>model_coefs <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date_stamp, sector) <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">fit_ols =</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="at">.x =</span> data, <span class="at">.f =</span> <span class="sc">~</span><span class="fu">lm</span>(log_pb <span class="sc">~</span> roe, <span class="at">data =</span> .x)),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">fit_ts =</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="at">.x =</span> data, <span class="at">.f =</span> <span class="sc">~</span><span class="fu">mblm</span>(log_pb <span class="sc">~</span> roe, <span class="at">data =</span> .x, <span class="at">repeated =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">int_ols =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="at">.x =</span> fit_ols, <span class="at">.f =</span> <span class="cf">function</span>(x) <span class="fu">coef</span>(<span class="fu">summary</span>(x))[<span class="st">&#39;(Intercept)&#39;</span>, <span class="st">&#39;Estimate&#39;</span>]),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">slp_ols =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="at">.x =</span> fit_ols, <span class="at">.f =</span> <span class="cf">function</span>(x) <span class="fu">coef</span>(<span class="fu">summary</span>(x))[<span class="st">&#39;roe&#39;</span>, <span class="st">&#39;Estimate&#39;</span>]),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">int_ts =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="at">.x =</span> fit_ts, <span class="at">.f =</span> <span class="cf">function</span>(x) <span class="fu">coef</span>(<span class="fu">summary</span>(x))[<span class="st">&#39;(Intercept)&#39;</span>, <span class="st">&#39;Estimate&#39;</span>]),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">slp_ts =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="at">.x =</span> fit_ts, <span class="at">.f =</span> <span class="cf">function</span>(x) <span class="fu">coef</span>(<span class="fu">summary</span>(x))[<span class="st">&#39;roe&#39;</span>, <span class="st">&#39;Estimate&#39;</span>]),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_min =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="at">.x =</span> data, <span class="at">.f =</span> <span class="sc">~</span><span class="fu">min</span>(.x<span class="sc">$</span>roe)),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_max =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="at">.x =</span> data, <span class="at">.f =</span> <span class="sc">~</span><span class="fu">max</span>(.x<span class="sc">$</span>roe)),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_min =</span> int_ts <span class="sc">+</span> slp_ts <span class="sc">*</span> x_min,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_max =</span> int_ts <span class="sc">+</span> slp_ts <span class="sc">*</span> x_max</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fit_ols, <span class="sc">-</span>fit_ts, <span class="sc">-</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe, <span class="at">y =</span> log_pb)) <span class="sc">+</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">reorder</span>(sector, <span class="fu">as.numeric</span>(sector)), <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">scales =</span> <span class="st">&#39;free&#39;</span>) <span class="sc">+</span> </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="st">&quot;#3366FF&quot;</span>) <span class="sc">+</span> </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x_min, <span class="at">xend =</span> x_max, <span class="at">y =</span> y_min, <span class="at">yend =</span> y_max),</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(model_coefs, date_stamp <span class="sc">==</span> <span class="fu">as.Date</span>(<span class="st">&#39;2021-06-30&#39;</span>)),</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">&#39;grey40&#39;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Log book / price ratio versus return on equity by industry&#39;</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent OLS (blue) and independent Theil-Sen (grey)&#39;</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Return on equity&#39;</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Log price / book ratio&#39;</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  def_theme1</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Once again we might argue the robust regression fits the data better. Witness group 1 comprising the “Industrials” sector, whereby the data points distinct from the diagonal cluster, skews the fit.</p>
<p><br></p>
<p>Below, the intercepts and slopes for each of the individual linear models are plotted.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">sector =</span> <span class="fu">as.factor</span>(model_coefs<span class="sc">$</span>sector), </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept =</span> model_coefs<span class="sc">$</span>int_ols, </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">slope =</span> model_coefs<span class="sc">$</span>slp_ols, </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">source =</span> <span class="fu">rep</span>(<span class="st">&quot;OLS&quot;</span>, <span class="dv">11</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sector =</span> <span class="fu">as.factor</span>(model_coefs<span class="sc">$</span>sector), </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept =</span> model_coefs<span class="sc">$</span>int_ts, </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">slope =</span> model_coefs<span class="sc">$</span>slp_ts, </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">source =</span> <span class="fu">rep</span>(<span class="st">&quot;TS&quot;</span>, <span class="dv">11</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="sc">%&gt;%</span> </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(source <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;OLS&#39;</span>,<span class="st">&#39;TS&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intercept, <span class="at">y =</span> slope, <span class="at">colour =</span> source)) <span class="sc">+</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">5.5</span>) <span class="sc">+</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> sector), <span class="at">nudge_x =</span> <span class="fl">0.03</span>, <span class="at">nudge_y =</span> <span class="fl">0.05</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Regression intercept and slope&#39;</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent OLS and Theil-Sen&#39;</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Intercept&#39;</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Slope&#39;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  def_theme1 <span class="sc">+</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;OLS&quot;</span><span class="ot">=</span><span class="st">&quot;#3366FF&quot;</span>, <span class="st">&quot;TS&quot;</span><span class="ot">=</span><span class="st">&quot;grey40&quot;</span>))</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>A couple of the OLS models have negative slopes and consistent with the observations above, the Theil-Sen slopes are more compact or closer to each other.</p>
<p><br></p>
</div>
<div id="sector-analysis-2" class="section level2">
<h2>Sector analysis 2</h2>
<p>We now add a Least Squares Dummy Variable regression. The plot below is presented with fixed scales to demonstrate the identical slopes that the LSDV structure enforces.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date_stamp, sector, log_pb, log_mkt_cap, roe, log_assets, log_equity_cln, leverage)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(log_pb <span class="sc">~</span> roe <span class="sc">+</span> sector, <span class="at">data =</span> data1)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>lsdv_data <span class="ot">&lt;-</span> rec <span class="sc">%&gt;%</span> <span class="fu">step_dummy</span>(sector, <span class="at">keep_original_cols =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">prep</span>(<span class="at">training =</span> data) <span class="sc">%&gt;%</span> <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>lsdv_mdl <span class="ot">&lt;-</span> <span class="fu">lm</span>(log_pb <span class="sc">~</span> roe <span class="sc">+</span> sector_X2 <span class="sc">+</span> sector_X3 <span class="sc">+</span> sector_X4 <span class="sc">+</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>               sector_X5 <span class="sc">+</span> sector_X6 <span class="sc">+</span> sector_X7 <span class="sc">+</span> sector_X8 <span class="sc">+</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>               sector_X9 <span class="sc">+</span> sector_X10 <span class="sc">+</span> sector_X11, </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> lsdv_data)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>lsdv_data<span class="sc">$</span>lsvd_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lsdv_mdl)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>lsvd_pred <span class="ot">&lt;-</span> lsdv_data<span class="sc">$</span>lsvd_pred</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> p1 <span class="sc">+</span> </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe, <span class="at">y =</span> lsvd_pred), <span class="at">data =</span> lsdv_data, <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent OLS (blue), independent Theil-Sen (grey) and LSDV (black)&#39;</span>) <span class="sc">+</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">reorder</span>(sector, <span class="fu">as.numeric</span>(sector)), <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">scales =</span> <span class="st">&#39;fixed&#39;</span>) <span class="sc">+</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  def_theme1</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>p2</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>The plot is a little harder to read with the constant scale. We can see however that the LSDV forces an unnatural fit. Sector 5 for example, (Financial Services) has a much smaller slope than would appear warranted. This is driven by the influence of other sectors that have a large slope. Financials are in effect an outlier among sectors and the rigidity of the model does not allow the data to influence this sectors slope.</p>
<p><br></p>
<p>Intercepts and slopes for individual linear models by sector, and the LSDV model.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>lsdv_mdl_coef <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">coef</span>(lsdv_mdl)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&#39;intercept&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">slope =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(lsdv_mdl)[<span class="st">&#39;roe&#39;</span>]))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>lsdv_mdl_coef[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>lsdv_mdl_coef <span class="ot">&lt;-</span> lsdv_mdl_coef[lsdv_mdl_coef<span class="sc">$</span>intercept <span class="sc">!=</span> <span class="st">&#39;roe&#39;</span>, ]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>lsdv_mdl_coef<span class="sc">$</span>intercept <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">gsub</span>(<span class="st">&quot;[^0-9.]&quot;</span>, <span class="st">&quot;&quot;</span>,  lsdv_mdl_coef<span class="sc">$</span>intercept))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>lsdv_mdl_coef<span class="sc">$</span>source <span class="ot">&lt;-</span> <span class="st">&#39;LSDV&#39;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(lsdv_mdl_coef)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;sector&#39;</span>,<span class="st">&#39;intercept&#39;</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>lm_mdl_coefs <span class="ot">&lt;-</span> model_coefs <span class="sc">%&gt;%</span> </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date_stamp <span class="sc">==</span> <span class="fu">as.Date</span>(<span class="st">&#39;2021-06-30&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sector, int_ols, slp_ols) <span class="sc">%&gt;%</span> </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sector =</span> <span class="fu">as.factor</span>(sector), <span class="at">source =</span> <span class="st">&#39;OLS&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">intercept =</span> int_ols, <span class="at">slope =</span> slp_ols)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(model_coefs_all, lsdv_mdl_coef)  </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>c2 <span class="ot">&lt;-</span> model_coefs_all <span class="sc">%&gt;%</span> </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(source <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;OLS&#39;</span>,<span class="st">&#39;TS&#39;</span>,<span class="st">&#39;LSDV&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intercept, <span class="at">y =</span> slope, <span class="at">colour =</span> source)) <span class="sc">+</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">5.5</span>) <span class="sc">+</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> sector), <span class="at">nudge_x =</span> <span class="fl">0.03</span>, <span class="at">nudge_y =</span> <span class="fl">0.05</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Regression intercept and slope&#39;</span>,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent OLS, Theil-Sen and LSDV&#39;</span>,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Intercept&#39;</span>,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Slope&#39;</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  def_theme1 <span class="sc">+</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;OLS&quot;</span><span class="ot">=</span><span class="st">&quot;#3366FF&quot;</span>, <span class="st">&quot;TS&quot;</span><span class="ot">=</span><span class="st">&quot;grey40&quot;</span>, <span class="st">&quot;LSDV&quot;</span><span class="ot">=</span><span class="st">&quot;black&quot;</span>))</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>c2</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-7-1.png" width="672" /> As discussed above, the LSDV model enforces a constant slope across groups and we can see this above.</p>
</div>
<div id="sector-analysis-3" class="section level2">
<h2>Sector analysis 3</h2>
<p>We now look at Multi level models. The expectation here is that parameters estimated with this model (as compared to independent OLS models) will shrink to a mean as the overall data influences each groups coefficients.</p>
<p>Of interest is the extent to which the shrinkage aligns coeffiencents with the Theil-Sen robust model.</p>
<p>The mixed effects regression line plotted below is estimated with the <code>lme4</code> package</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixed effects model with fixed and random intercept </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>lme_1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(log_pb <span class="sc">~</span> roe <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> roe <span class="sc">|</span> sector), <span class="at">data =</span> data)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add predicted values for line in scatter plot</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>lme1_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lme_1)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> p2 <span class="sc">+</span> </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe, <span class="at">y =</span> lme1_pred), <span class="at">data =</span> data, <span class="at">size =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="st">&#39;magenta2&#39;</span>, <span class="at">linetype =</span> <span class="st">&#39;longdash&#39;</span>) <span class="sc">+</span> <span class="co">#darkorchid3</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent OLS (blue), independent Theil-Sen (grey), LSDV (black) </span><span class="sc">\n</span><span class="st">and Multi level basis (dashed magenta)&#39;</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">reorder</span>(sector, <span class="fu">as.numeric</span>(sector)), <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">scales =</span> <span class="st">&#39;free&#39;</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>p3</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>And the the coefficients.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot coefficients - add coefficients to existing plot</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># CHANGE SOURCE TO MODEL</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>lme1_coefs <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">sector =</span> <span class="fu">as.factor</span>(<span class="fu">rownames</span>(<span class="fu">ranef</span>(lme_1)<span class="sc">$</span>sector)),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">intercept =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(lme_1)<span class="sc">$</span>sector[<span class="st">&#39;(Intercept)&#39;</span>]),  <span class="co"># works only for single grouping variable</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">slope =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(lme_1)<span class="sc">$</span>sector[<span class="st">&#39;roe&#39;</span>]),              <span class="co"># works only for single grouping variable</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="fu">rep</span>(<span class="st">&#39;Multi level&#39;</span>, <span class="dv">11</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(model_coefs_all, lme1_coefs)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="sc">%&gt;%</span> </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(source <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;OLS&#39;</span>,<span class="st">&#39;TS&#39;</span>,<span class="st">&#39;LSDV&#39;</span>,<span class="st">&#39;Multi level&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intercept, <span class="at">y =</span> slope, <span class="at">colour =</span> source)) <span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">5.5</span>) <span class="sc">+</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> sector), <span class="at">nudge_x =</span> <span class="fl">0.03</span>, <span class="at">nudge_y =</span> <span class="fl">0.05</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Regression intercept and slope&#39;</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent OLS, LSDV, Theil-Sen and Mixed effects&#39;</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Intercept&#39;</span>,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Slope&#39;</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  def_theme1 <span class="sc">+</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;OLS&quot;</span><span class="ot">=</span><span class="st">&quot;#3366FF&quot;</span>, <span class="st">&quot;TS&quot;</span><span class="ot">=</span><span class="st">&quot;grey40&quot;</span>, <span class="st">&quot;LSDV&quot;</span><span class="ot">=</span><span class="st">&quot;black&quot;</span>, <span class="st">&quot;Multi level&quot;</span><span class="ot">=</span><span class="st">&quot;magenta2&quot;</span>))</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Compared to expectation, that was a little underwhelming. There is essentially no difference between the mixed effects and individual OLS models. This is probably due to the small number of groups (11) and the large amount of data points within each group.</p>
<p>EXPLAIN WHY THIS OCCURS - LESS VARIATION B/W GROUPS ETC. IT MAY BE PRUDENT TO GO NEXT LEVEL DOWN, IE INDUSTRY.</p>
<p>Note that the model as defined estimates a correlation between the intercept and slope for each sector.</p>
<p>IS THIS REASONABLE? WHAT DOES THE INTERCEPT AND SLOPE REPRESENT IN THE PB-ROE MODEL (REFER ORIGINAL PAPER)</p>
<p><br></p>
</div>
<div id="bayesian-approach" class="section level2">
<h2>Bayesian approach</h2>
<p>Next, we estimate the multi level model using a bayesian approach. This will allow for the specification of priors for both the slope and intercept coefficients, and also the correlation between those coefficients. An appropriately specified prior should enforce more shrinkage (remember we are encoding our domain knowledge here, and assuming a negative relation between P/B ratio and ROE does not make sense).</p>
<p>The bayesian mixed effects model below is fit with the <a href="https://github.com/rmcelreath/rethinking">Rethinking</a> package. In this model the predictor, return on equity, is standardised to mean zero and unit variance. This helps in setting appropriate priors.</p>
<p>The intercepts is defined as the outcome (log_pb) when the predictor (roe) is zero. When the predictor variable is standardised like we have just done, it’s mean is zero. So what is a reasonable expectation of the log_bp when roe is at it’s mean? Luckily the second plot above uses the standardised ROE and we can see this is associated with a log_pb of circa 1.25. That converts to a P/B ratio of around 3.5 (the exponent of 1.25).</p>
<p>DISCUSS STANDARD DEVIATION AND BETA PRIOR.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data in Rethinking / McElreath format</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_pb =</span> data<span class="sc">$</span>log_pb,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">roe    =</span> data<span class="sc">$</span>roe,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">vol    =</span> data<span class="sc">$</span>vol_ari_60d,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sector =</span> data<span class="sc">$</span>sector,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n      =</span> <span class="fu">nrow</span>(data)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>bayes1 <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alist</span>(</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Response distribution</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    log_pb <span class="sc">~</span> <span class="fu">normal</span>(mu, sigma),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear model &amp; residual SD</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> a_sector[sector] <span class="sc">+</span> b_sector[sector] <span class="sc">*</span> roe,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> <span class="fu">exponential</span>(<span class="dv">1</span>),                     <span class="co"># prior for residual SD of response dist.</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variance covariance matrix for intercept and slope (note multi_normal = dmvnorm2)</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(a_sector, b_sector)[sector] <span class="sc">~</span> <span class="fu">multi_normal</span>(<span class="fu">c</span>(a, b), Rho, sigma_sector),</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Priors for covariance matrix</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    a <span class="sc">~</span> <span class="fu">normal</span>(<span class="fl">1.25</span>, <span class="dv">1</span>),                        <span class="co"># prior for average intercept</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    b <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">1</span>, <span class="fl">1.5</span>),                         <span class="co"># prior for average slope</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    Rho <span class="sc">~</span> <span class="fu">lkj_corr</span>(<span class="dv">2</span>),                          <span class="co"># prior for correlation matrix</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    sigma_sector <span class="sc">~</span> <span class="fu">exponential</span>(<span class="dv">1</span>)               <span class="co"># prior for vector of SD&#39;s (slope &amp; int) in covariance matrix</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;cffcf17c79be454a4c22c4edbb973e15&#39; NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
## Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
## Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
## Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
## Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
## Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
## Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
## Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
## Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
## Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
## Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
## Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 2.45 seconds (Warm-up)
## Chain 1:                0.916 seconds (Sampling)
## Chain 1:                3.366 seconds (Total)
## Chain 1:</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Coefficients</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>bayes1_coef_tbl <span class="ot">&lt;-</span> <span class="fu">coeftab</span>(bayes1)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>bayes1_coef <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">coef =</span> <span class="fu">row.names</span>(bayes1_coef_tbl<span class="sc">@</span>coefs), <span class="at">value =</span> bayes1_coef_tbl<span class="sc">@</span>coefs, <span class="at">row.names =</span> <span class="cn">NULL</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>bayes1_coef<span class="sc">$</span>t <span class="ot">&lt;-</span> <span class="fu">substr</span>(bayes1_coef<span class="sc">$</span>coef, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>bayes1_coef<span class="sc">$</span>s <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">D&quot;</span>, <span class="st">&quot;&quot;</span>, bayes1_coef<span class="sc">$</span>coef))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>bayes1_coef1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sector =</span> <span class="fu">as.factor</span>(bayes1_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes1_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes1_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>s),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">intercept =</span> bayes1_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes1_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes1_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;a&#39;</span>, ]<span class="sc">$</span>bayes1 <span class="sc">+</span> bayes1_coef[bayes1_coef<span class="sc">$</span>coef <span class="sc">==</span> <span class="st">&#39;a&#39;</span>, ]<span class="sc">$</span>bayes1 <span class="sc">*</span> <span class="dv">0</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">slope =</span> bayes1_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes1_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes1_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>bayes1 <span class="sc">+</span> bayes1_coef[bayes1_coef<span class="sc">$</span>coef <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>bayes1 <span class="sc">*</span> <span class="dv">0</span>, <span class="co"># included fixed effect / popn level param</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">&#39;Bayes normal&#39;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(model_coefs_all, bayes1_coef1)  </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>bayes1_pred_samples <span class="ot">&lt;-</span> <span class="fu">link</span>(bayes1, <span class="at">data =</span> d)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>bayes1_pred <span class="ot">&lt;-</span> <span class="fu">apply</span>(bayes1_pred_samples, <span class="dv">2</span>, mean)</span></code></pre></div>
<p>Here is the plot of the regression.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> p1 <span class="sc">+</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe, <span class="at">y =</span> bayes1_pred), <span class="at">data =</span> data, <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">colour =</span> <span class="st">&#39;magenta&#39;</span>) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent OLS (blue), independent Theil-Sen (grey) </span><span class="sc">\n</span><span class="st">and Bayesian mixed effects (magenta)&#39;</span>) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  def_theme1</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>p4</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p><br></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(source <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Bayes normal&#39;</span>, <span class="st">&#39;Multi level&#39;</span>, <span class="st">&#39;TS&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intercept, <span class="at">y =</span> slope, <span class="at">colour =</span> source)) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">5.5</span>) <span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> sector), <span class="at">nudge_x =</span> <span class="fl">0.03</span>, <span class="at">nudge_y =</span> <span class="fl">0.05</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Regression intercept and slope&#39;</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent Bayesian mulitlevel and Mixed effects&#39;</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Intercept&#39;</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Slope&#39;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  def_theme1 <span class="sc">+</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;Bayes normal&quot;</span><span class="ot">=</span><span class="st">&quot;black&quot;</span>, <span class="st">&quot;TS&quot;</span><span class="ot">=</span><span class="st">&quot;grey40&quot;</span>, <span class="st">&quot;Multi level&quot;</span><span class="ot">=</span><span class="st">&quot;magenta2&quot;</span>))</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>THE PLOT ABOVE TO SHOW BAYESIAN MULTI LEVEL, FREQUENTIST MIXED AND TS.</p>
<p>Let’s re-estimate the bayesian model using tighter priors and a student t likelihood for a more robust approach. Can we turn those pesky negative slopes positive?</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data in Rethinking / McElreath format</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>bayes2 <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alist</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Response distribution</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    log_pb <span class="sc">~</span> <span class="fu">dstudent</span>(nu , mu, sigma),</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear model</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> a_sector[sector] <span class="sc">+</span> b_sector[sector] <span class="sc">*</span> roe,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variance co-variance matrix prior for intercept and slope</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(a_sector, b_sector)[sector] <span class="sc">~</span> <span class="fu">multi_normal</span>(<span class="fu">c</span>(a, b), Rho, sigma_sector),</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    a <span class="sc">~</span> <span class="fu">normal</span>(<span class="fl">1.25</span>, <span class="dv">1</span>),                         <span class="co"># prior for average intercept</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    b <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">1</span>, <span class="fl">1.5</span>),                          <span class="co"># prior for average slope</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    nu <span class="sc">~</span> <span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.1</span>),                          <span class="co"># use brms default prior</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    sigma_sector <span class="sc">~</span> <span class="fu">exponential</span>(<span class="dv">1</span>),</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> <span class="fu">exponential</span>(<span class="dv">1</span>),                      <span class="co"># prior for residual standard deviation of response dist.</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    Rho <span class="sc">~</span> <span class="fu">lkj_corr</span>(<span class="dv">2</span>)                            <span class="co"># prior for correlation matrix</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;1f64478447f36bbb8c3df23290c06afa&#39; NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
## Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
## Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
## Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
## Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
## Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
## Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
## Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
## Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
## Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
## Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
## Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 2.578 seconds (Warm-up)
## Chain 1:                1.34 seconds (Sampling)
## Chain 1:                3.918 seconds (Total)
## Chain 1:</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Coefficients</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>bayes2_coef_tbl <span class="ot">&lt;-</span> <span class="fu">coeftab</span>(bayes2)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>bayes2_coef <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">coef =</span> <span class="fu">row.names</span>(bayes2_coef_tbl<span class="sc">@</span>coefs), <span class="at">value =</span> bayes2_coef_tbl<span class="sc">@</span>coefs, <span class="at">row.names =</span> <span class="cn">NULL</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>bayes2_coef<span class="sc">$</span>t <span class="ot">&lt;-</span> <span class="fu">substr</span>(bayes2_coef<span class="sc">$</span>coef, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>bayes2_coef<span class="sc">$</span>s <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">D&quot;</span>, <span class="st">&quot;&quot;</span>, bayes2_coef<span class="sc">$</span>coef))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>bayes2_coef1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sector =</span> <span class="fu">as.factor</span>(bayes2_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes2_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes2_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>s),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">intercept =</span> bayes2_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes2_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes2_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;a&#39;</span>, ]<span class="sc">$</span>bayes2 <span class="sc">+</span> bayes2_coef[bayes2_coef<span class="sc">$</span>coef <span class="sc">==</span> <span class="st">&#39;a&#39;</span>, ]<span class="sc">$</span>bayes2 <span class="sc">*</span> <span class="dv">0</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">slope =</span> bayes2_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes2_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes2_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>bayes2 <span class="sc">+</span> bayes2_coef[bayes2_coef<span class="sc">$</span>coef <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>bayes2 <span class="sc">*</span> <span class="dv">0</span>, <span class="co"># included fixed effect / popn level param</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">&#39;Bayes student&#39;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(model_coefs_all, bayes2_coef1)  </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>bayes2_pred_samples <span class="ot">&lt;-</span> <span class="fu">link</span>(bayes2, <span class="at">data =</span> d)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>bayes2_pred <span class="ot">&lt;-</span> <span class="fu">apply</span>(bayes2_pred_samples, <span class="dv">2</span>, mean)</span></code></pre></div>
<p><br> <br></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe, <span class="at">y =</span> log_pb)) <span class="sc">+</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">reorder</span>(sector, <span class="fu">as.numeric</span>(sector)), <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">scales =</span> <span class="st">&#39;free&#39;</span>) <span class="sc">+</span> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe, <span class="at">y =</span> bayes1_pred), <span class="at">data =</span> data, <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">colour =</span> <span class="st">&#39;blue&#39;</span>) <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe, <span class="at">y =</span> bayes2_pred), <span class="at">data =</span> data, <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">colour =</span> <span class="st">&#39;green&#39;</span>) <span class="sc">+</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x_min, <span class="at">xend =</span> x_max, <span class="at">y =</span> y_min, <span class="at">yend =</span> y_max),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(model_coefs, date_stamp <span class="sc">==</span> <span class="fu">as.Date</span>(<span class="st">&#39;2021-06-30&#39;</span>)),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">&#39;grey40&#39;</span>, <span class="at">size =</span> <span class="fl">0.3</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Log book / price ratio versus return on equity by industry&#39;</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with Bayes normal (blue), Bayes student t (green) and independent Theil-Sen (grey)&#39;</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Return on equity&#39;</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Log price / book ratio&#39;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  def_theme1</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>p5</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p><br></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(source <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Bayes normal&#39;</span>,<span class="st">&#39;Bayes student&#39;</span>, <span class="st">&#39;TS&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intercept, <span class="at">y =</span> slope, <span class="at">colour =</span> source)) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">5.5</span>) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> sector), <span class="at">nudge_x =</span> <span class="fl">0.03</span>, <span class="at">nudge_y =</span> <span class="fl">0.05</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Regression intercept and slope&#39;</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with independent TS and Bayesian multi level (student &amp; normal)l&#39;</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Intercept&#39;</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Slope&#39;</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  def_theme1 <span class="sc">+</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;Bayes normal&quot;</span><span class="ot">=</span><span class="st">&quot;blue&quot;</span>, <span class="st">&quot;Bayes student&quot;</span><span class="ot">=</span><span class="st">&quot;green&quot;</span>, <span class="st">&quot;TS&quot;</span><span class="ot">=</span><span class="st">&quot;grey40&quot;</span>, <span class="st">&quot;Multi level&quot;</span><span class="ot">=</span><span class="st">&quot;magenta2&quot;</span>))</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="bayesian-model-with-measurement-error" class="section level2">
<h2>Bayesian model with measurement error</h2>
<p>Model per McElreath p 493.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data in Rethinking / McElreath format</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>bayes3 <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alist</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Response distribution</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    log_pb <span class="sc">~</span> <span class="fu">dstudent</span>(nu, log_pb_t, sigma),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    vector[n]<span class="sc">:</span>log_pb_t <span class="sc">~</span> <span class="fu">dstudent</span>(nu_t, mu, sigma),  <span class="co"># declare a vector of length n for each log_pb_t???  https://github.com/rmcelreath/rethinking/tree/Experimental#multilevel-model-formulas</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear model</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> a_sector[sector] <span class="sc">+</span> b_sector[sector] <span class="sc">*</span> roe,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variance co-variance matrix prior for intercept and slope</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(a_sector, b_sector)[sector] <span class="sc">~</span> <span class="fu">multi_normal</span>(<span class="fu">c</span>(a, b), Rho, sigma_sector),</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    a <span class="sc">~</span> <span class="fu">normal</span>(<span class="fl">1.25</span>, <span class="dv">1</span>),                         <span class="co"># prior for average intercept</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    b <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">1</span>, <span class="fl">1.5</span>),                          <span class="co"># prior for average slope</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    nu <span class="sc">~</span> <span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.1</span>),                          <span class="co"># brms default prior</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    nu_t <span class="sc">~</span> <span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.1</span>),                        <span class="co"># brms default prior</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    sigma_sector <span class="sc">~</span> <span class="fu">exponential</span>(<span class="dv">1</span>),</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> <span class="fu">exponential</span>(<span class="dv">1</span>),                      <span class="co"># prior for residual standard deviation of response dist.</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    Rho <span class="sc">~</span> <span class="fu">lkj_corr</span>(<span class="dv">2</span>)                            <span class="co"># prior for correlation matrix</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;2f91776600a6b798e2d9cbe9a551e7f0&#39; NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
## Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
## Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
## Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
## Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
## Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
## Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
## Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
## Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
## Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
## Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
## Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 8.499 seconds (Warm-up)
## Chain 1:                7.821 seconds (Sampling)
## Chain 1:                16.32 seconds (Total)
## Chain 1:</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Coefficients</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>bayes3_coef_tbl <span class="ot">&lt;-</span> <span class="fu">coeftab</span>(bayes3)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>bayes3_coef <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">coef =</span> <span class="fu">row.names</span>(bayes3_coef_tbl<span class="sc">@</span>coefs), <span class="at">value =</span> bayes3_coef_tbl<span class="sc">@</span>coefs, <span class="at">row.names =</span> <span class="cn">NULL</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>bayes3_coef<span class="sc">$</span>t <span class="ot">&lt;-</span> <span class="fu">substr</span>(bayes3_coef<span class="sc">$</span>coef, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>bayes3_coef<span class="sc">$</span>s <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">D&quot;</span>, <span class="st">&quot;&quot;</span>, bayes3_coef<span class="sc">$</span>coef))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>bayes3_coef1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sector =</span> <span class="fu">as.factor</span>(bayes3_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes3_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes3_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>s),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">intercept =</span> bayes3_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes3_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes3_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;a&#39;</span>, ]<span class="sc">$</span>bayes3 <span class="sc">+</span> bayes3_coef[bayes3_coef<span class="sc">$</span>coef <span class="sc">==</span> <span class="st">&#39;a&#39;</span>, ]<span class="sc">$</span>bayes3 <span class="sc">*</span> <span class="dv">0</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">slope =</span> bayes3_coef[<span class="sc">!</span><span class="fu">is.na</span>(bayes3_coef<span class="sc">$</span>s) <span class="sc">&amp;</span> bayes3_coef<span class="sc">$</span>t <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>bayes3 <span class="sc">+</span> bayes3_coef[bayes3_coef<span class="sc">$</span>coef <span class="sc">==</span> <span class="st">&#39;b&#39;</span>, ]<span class="sc">$</span>bayes3 <span class="sc">*</span> <span class="dv">0</span>, <span class="co"># included fixed effect / popn level param</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">&#39;Bayes student me&#39;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(model_coefs_all, bayes3_coef1)  </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>bayes3_pred_samples <span class="ot">&lt;-</span> <span class="fu">link</span>(bayes3, <span class="at">data =</span> d)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>bayes3_pred <span class="ot">&lt;-</span> <span class="fu">apply</span>(bayes3_pred_samples, <span class="dv">2</span>, mean)</span></code></pre></div>
<p>Scatter plots</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> p5 <span class="sc">+</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> roe, <span class="at">y =</span> bayes3_pred), <span class="at">data =</span> data, <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">colour =</span> <span class="st">&#39;red&#39;</span>) <span class="sc">+</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Log book / price ratio versus return on equity by industry&#39;</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with Bayes normal (blue), Bayes student t (green), Bayes student t with </span><span class="sc">\n</span><span class="st">measurement error (red) and independent Theil-Sen (grey)&#39;</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Return on equity&#39;</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Log price / book ratio&#39;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>p6</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>Coefficient plots</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(source <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Bayes normal&#39;</span>,<span class="st">&#39;Bayes student&#39;</span>,<span class="st">&#39;Bayes student me&#39;</span>, <span class="st">&#39;TS&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intercept, <span class="at">y =</span> slope, <span class="at">colour =</span> source)) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">5.5</span>) <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> sector), <span class="at">nudge_x =</span> <span class="fl">0.03</span>, <span class="at">nudge_y =</span> <span class="fl">0.05</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Regression intercept and slope&#39;</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with various Bayesian multi level specifications and independent Theil-Sen&#39;</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Intercept&#39;</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Slope&#39;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  def_theme1 <span class="sc">+</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;Bayes normal&quot;</span><span class="ot">=</span><span class="st">&quot;blue&quot;</span>, <span class="st">&quot;Bayes student&quot;</span><span class="ot">=</span><span class="st">&quot;green&quot;</span>, <span class="st">&quot;Bayes student me&quot;</span><span class="ot">=</span><span class="st">&quot;red&quot;</span>, <span class="st">&quot;TS&quot;</span><span class="ot">=</span><span class="st">&quot;grey40&quot;</span>))</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p><br></p>
<div id="industry-level" class="section level3">
<h3>Industry level</h3>
<p>Lastly, we will look at a mixed model with to levels of nesting (this is where the hierarchical term comes from).</p>
<p>TO DO - Nested by sector and industry, individual OLS, TS, bayes mixed and freq mixed</p>
</div>
</div>
<div id="appendix" class="section level2">
<h2>Appendix</h2>
<div id="model-in-brms" class="section level3">
<h3>Model in <code>brms</code></h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> d, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> student,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#log_pb ~ 1 + roe + (1 + roe || sector),</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    log_pb <span class="sc">|</span> <span class="fu">se</span>(vol, <span class="at">sigma =</span> <span class="cn">TRUE</span>) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> roe <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> roe <span class="sc">||</span> sector),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">5</span>, <span class="dv">2</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">0.5</span>), <span class="at">class =</span> b),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma), </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.1</span>), <span class="at">class =</span> nu)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">#prior(lkj(2), class = cor)     not required as correlation not being modeled</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Coefficients</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>b1_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(b1)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>b1_coef_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(b1_coef)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>b1_coef_df<span class="sc">$</span>sector <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rownames</span>(b1_coef_df))</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>b1_coef_df<span class="sc">$</span>source <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&#39;Bayes student me (no correlation)&#39;</span>, <span class="dv">11</span>) </span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>b1_coef_df <span class="ot">&lt;-</span>b1_coef_df[, <span class="fu">c</span>(<span class="st">&#39;sector&#39;</span>, <span class="st">&#39;sector.Estimate.Intercept&#39;</span>, <span class="st">&#39;sector.Estimate.roe&#39;</span>, <span class="st">&#39;source&#39;</span>)]</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(b1_coef_df) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;sector&quot;</span>, <span class="st">&quot;intercept&quot;</span>, <span class="st">&quot;slope&quot;</span>, <span class="st">&quot;source&quot;</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(model_coefs_all, b1_coef_df) </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co">#model_coefs_all &lt;- model_coefs_all[-c(89:110), ]</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>model_coefs_all <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(source <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Bayes student me (no correlation)&#39;</span>,<span class="st">&#39;Bayes student me&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> intercept, <span class="at">y =</span> slope, <span class="at">colour =</span> source)) <span class="sc">+</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">5.5</span>) <span class="sc">+</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> sector), <span class="at">nudge_x =</span> <span class="fl">0.03</span>, <span class="at">nudge_y =</span> <span class="fl">0.05</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Regression intercept and slope&#39;</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Estimated with Bayesian multi level student t </span><span class="sc">\n</span><span class="st">likelihood (correlation and no correlation - brms)&#39;</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Intercept&#39;</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Slope&#39;</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  def_theme1 <span class="sc">+</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;Bayes student me (no correlation)&quot;</span><span class="ot">=</span><span class="st">&quot;blue&quot;</span>, <span class="st">&quot;Bayes student me&quot;</span><span class="ot">=</span><span class="st">&quot;magenta2&quot;</span>))</span></code></pre></div>
<p><img src="mixed_effect_stock_valuation_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>None of the above has communicated uncertainty around parameters for the bayesian models</p>
</div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>[1] Harrison XA, Donaldson L, Correa-Cano ME, Evans J, Fisher DN, Goodwin CED, Robinson BS, Hodgson DJ, Inger R. 2018. A brief introduction to mixed effects modelling and multi-model inference in ecology. PeerJ 6:e4794 <a href="https://doi.org/10.7717/peerj.4794" class="uri">https://doi.org/10.7717/peerj.4794</a><br />
<br><br />
[2] Paul-Christian Bürkner. Advanced Bayesian Multilevel Modeling with the R Package brms. 2018<br />
<br><br />
[3] Green, Brice and Thomas, Samuel, Inference and Prediction of Stock Returns using Multilevel Models (August 31, 2019). Available at SSRN: <a href="https://ssrn.com/abstract=3411358" class="uri">https://ssrn.com/abstract=3411358</a> or <a href="http://dx.doi.org/10.2139/ssrn.3411358" class="uri">http://dx.doi.org/10.2139/ssrn.3411358</a><br />
<br></p>
<p>Mixed effects models using lme4 lme4 manual:- <a href="https://lme4.r-forge.r-project.org/book/" class="uri">https://lme4.r-forge.r-project.org/book/</a></p>
<p>lme4 manual:- <a href="https://www.chalmers.se/sv/institutioner/math/forskning/forskarutbildning/forskarutbildning-matematisk-statistik/forskarutbildningskurser-matematisk-statistik/Documents/bates_manual.pdf" class="uri">https://www.chalmers.se/sv/institutioner/math/forskning/forskarutbildning/forskarutbildning-matematisk-statistik/forskarutbildningskurser-matematisk-statistik/Documents/bates_manual.pdf</a></p>
<p>vignette:- <a href="https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf" class="uri">https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf</a></p>
<p>Doug Bates <a href="pres:-" class="uri">pres:-</a> <a href="http://pages.stat.wisc.edu/~bates/UseR2008/WorkshopD.pdf" class="uri">http://pages.stat.wisc.edu/~bates/UseR2008/WorkshopD.pdf</a></p>
<p>Example to find lme4 predict coefficients:- <a href="https://stats.stackexchange.com/questions/174203/predict-function-for-lmer-mixed-effects-models/174227" class="uri">https://stats.stackexchange.com/questions/174203/predict-function-for-lmer-mixed-effects-models/174227</a></p>
<p>Various syntax <a href="notes:-" class="uri">notes:-</a> <a href="https://yury-zablotski.netlify.app/post/mixed-effects-models-2/" class="uri">https://yury-zablotski.netlify.app/post/mixed-effects-models-2/</a></p>
<p>Syntax cheat sheet:- <a href="https://stats.stackexchange.com/questions/13166/rs-lmer-cheat-sheet" class="uri">https://stats.stackexchange.com/questions/13166/rs-lmer-cheat-sheet</a></p>
<p>Sweep function:- <a href="https://stackoverflow.com/questions/3444889/how-to-use-the-sweep-function" class="uri">https://stackoverflow.com/questions/3444889/how-to-use-the-sweep-function</a></p>
<p>Plot reference:-<a href="https://www.tjmahr.com/plotting-partial-pooling-in-mixed-effects-models/" class="uri">https://www.tjmahr.com/plotting-partial-pooling-in-mixed-effects-models/</a></p>
<p>Model diagnostics:- <a href="https://www.ssc.wisc.edu/sscc/pubs/MM/MM_DiagInfer.html" class="uri">https://www.ssc.wisc.edu/sscc/pubs/MM/MM_DiagInfer.html</a></p>
<p>Shrinkage &amp; correlation:- <a href="http://doingbayesiandataanalysis.blogspot.com/2019/07/shrinkage-in-hierarchical-models-random.html" class="uri">http://doingbayesiandataanalysis.blogspot.com/2019/07/shrinkage-in-hierarchical-models-random.html</a></p>
<p>Diagnostics - <a href="https://www.ssc.wisc.edu/sscc/pubs/MM/MM_DiagInfer.html" class="uri">https://www.ssc.wisc.edu/sscc/pubs/MM/MM_DiagInfer.html</a></p>
<p><a href="https://bayesiancomputationbook.com/markdown/chp_04.html#mixing-group-and-common-parameters" class="uri">https://bayesiancomputationbook.com/markdown/chp_04.html#mixing-group-and-common-parameters</a></p>
<p><a href="https://www.cbssports.com/mlb/news/mlb-analytics-guru-who-could-be-the-next-nate-silver-has-a-revolutionary-new-stat/" class="uri">https://www.cbssports.com/mlb/news/mlb-analytics-guru-who-could-be-the-next-nate-silver-has-a-revolutionary-new-stat/</a></p>
<p><a href="https://www.baseballprospectus.com/news/article/26195/prospectus-feature-introducing-deserved-run-average-draand-all-its-friends/" class="uri">https://www.baseballprospectus.com/news/article/26195/prospectus-feature-introducing-deserved-run-average-draand-all-its-friends/</a></p>
<p><a href="https://www.baseballprospectus.com/news/article/26196/prospectus-feature-dra-an-in-depth-discussion/" class="uri">https://www.baseballprospectus.com/news/article/26196/prospectus-feature-dra-an-in-depth-discussion/</a></p>
<p>Robust bayesian regression - <a href="https://solomonkurz.netlify.app/post/2019-02-02-robust-linear-regression-with-student-s-t-distribution/" class="uri">https://solomonkurz.netlify.app/post/2019-02-02-robust-linear-regression-with-student-s-t-distribution/</a></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
